import{j as e,r as h}from"./index-DngLVFUg.js";import{u as W}from"./shopifyIdUtils-PhKRAdsZ.js";import{b as H,C as X,p as Y}from"./ConfirmationModal-2v7BHoQs.js";import{f as $,l as F}from"./flex-CRP9ZW6z.js";import{n as ee}from"./shopAtom-DHlAgFdS.js";import{i as se,t as ae,j as ne,d}from"./index-CZBhWrIY.js";import{r as te,L as re,o as ie,q as oe,p as le}from"./components-DCDtNDXQ.js";import{V as de}from"./VariantDetailColumns-BVbtcIaz.js";import{k as O,u as ce}from"./index-xIj4AxVg.js";import"./modal-bge_ITEm.js";var Z={};(function(s){var o=se;Object.defineProperty(s,"ActionIcon",{enumerable:!0,get:function(){return o.a}})})(Z);const ue=({product:s})=>{const{title:o}=s,{productId:m}=te();return e.jsxs($.Flex,{className:"w-full",children:[e.jsx(re,{to:`/merchant/products/${m}`,children:e.jsx(Z.ActionIcon,{variant:"outline",children:e.jsx(ee,{})})}),e.jsxs(ae.Title,{children:["Manage variant plans for ",o]})]})};var B={};(function(s){var o=ne;Object.defineProperty(s,"Box",{enumerable:!0,get:function(){return o.a}})})(B);const E=({disabled:s,handleDiscardChanges:o,handleSaveChanges:m,isLoading:b,setIsLoading:x})=>e.jsx($.Flex,{children:e.jsxs(B.Box,{className:"ms-auto flex gap-4",children:[e.jsx(H.Button,{disabled:s,onClick:o,variant:"outline",color:"danger",children:"Discard changes"}),e.jsx(H.Button,{disabled:s,onClick:m,isLoading:b,loader:e.jsx(F.Loader,{variant:"spinner"}),children:"Save Changes"})]})}),he=({sellingPlans:s,tableData:o,handleCheckboxChange:m,variantCheckboxes:b,handleAllVariantsChange:x,allVariantsChecked:k})=>e.jsxs(d.Table,{children:[e.jsx(d.Table.Header,{children:e.jsxs(d.Table.Row,{children:[e.jsx(d.Table.Head,{children:"Variant Title"}),s.map(r=>e.jsx(d.Table.Head,{children:r.node.name},r.node.id))]})}),e.jsxs(d.Table.Body,{children:[e.jsxs(d.Table.Row,{children:[e.jsx(d.Table.Head,{children:"All"}),s.map((r,g)=>e.jsx(d.Table.Head,{children:e.jsx(d.Checkbox,{checked:k[g],onChange:f=>x(g,f.target.checked)})},r.node.id))]}),o.map(r=>e.jsxs(d.Table.Row,{children:[e.jsx(d.Table.Cell,{children:e.jsx(de,{variant:r})}),s.map(g=>{const f=`${r.id}-${g.node.id}`;return e.jsx(d.Table.Cell,{children:e.jsx(d.Checkbox,{checked:b[f]||!1,onChange:v=>m(r.id,g.node.id,v.target.checked)})},f)})]},r.id))]})]}),fe=({product:s})=>{const{variants:{nodes:o},id:m}=s,[b]=ie(),x=b.get("groupId"),k=o.flatMap(a=>a.sellingPlanGroups.edges).find(a=>a.node.id===`gid://shopify/SellingPlanGroup/${x}`),r=(k==null?void 0:k.node.sellingPlans.edges)||[],[g,f]=h.useState(r.map(()=>!1)),[v,S]=h.useState({}),[G,R]=h.useState({}),[M,P]=h.useState(!1),[J,w]=h.useState(!1),[A,T]=h.useState(!1),C=h.useMemo(()=>o||[],[s]),c=oe(),K=le();h.useEffect(()=>{const a={};console.log("sellingPlans",r),C.forEach(n=>{r.forEach(i=>{var N,I,L;const l=`${n.id}-${i.node.id}`;let p=(N=n.sellingPlanGroups.edges.find(u=>u.node.id===`gid://shopify/SellingPlanGroup/${x}`))==null?void 0:N.node.sellingPlans.edges.some(u=>u.node.id===i.node.id);const j=((L=(I=i==null?void 0:i.node)==null?void 0:I.metafields)==null?void 0:L.nodes)||[],V=j.find(u=>u.key==="restrictedVariants"),y=j.find(u=>u.key==="addedVariants");if(j.length>0){const u=V?JSON.parse(V.value):[],z=y?JSON.parse(y.value):[];u.includes(n.id)?p=!1:z.includes(n.id)&&(p=!0)}a[l]=p||!1})}),S(a),R(a);const t=r.map(n=>C.every(i=>a[`${i.id}-${n.node.id}`]));f(t),P(!1)},[C,r,x]);const Q=(a,t,n)=>{S(i=>{const l={...i,[`${a}-${t}`]:n},p=C.every(j=>l[`${j.id}-${t}`]);return f(j=>{const V=[...j],y=r.findIndex(N=>N.node.id===t);return y!==-1&&(V[y]=p),V}),P(!0),l})},U=()=>{S(G),P(!1)},_=(a,t)=>{f(n=>{const i=[...n];return i[a]=t,i}),S(n=>{const i={...n};return C.forEach(l=>{const p=`${l.id}-${r[a].node.id}`;i[p]=t}),i}),P(!0)},D=async()=>{try{T(!0);const a=q(v),t={groupId:x,transformedVariantData:a},n=new FormData;n.append("variantData",JSON.stringify(t)),n.append("productId",m),n.append("appId",s.currentAppInstallation.app.id),c.submit(n,{method:"POST",action:".",encType:"multipart/form-data"})}catch(a){console.error("Failed to save changes:",a)}};h.useEffect(()=>{var a,t;c.state==="idle"&&c.data&&((a=c==null?void 0:c.data)!=null&&a.success?(O.success("Changes saved successfully!"),setTimeout(()=>{K(-1)},1e3)):O.error((t=c==null?void 0:c.data)==null?void 0:t.error),T(!1))},[c.state,c.data]);const q=a=>{let t={};for(let n in a){let[i,l]=n.split("-gid://shopify/SellingPlan/");l=`gid://shopify/SellingPlan/${l}`,t[l]||(t[l]={sellingPlanId:l,restrictedVariants:[],addedVariants:[]}),a[n]?t[l].addedVariants.push(i):t[l].restrictedVariants.push(i)}return Object.values(t)};return e.jsxs("div",{className:"w-full flex flex-col gap-4",children:[e.jsx(E,{disabled:!M,handleDiscardChanges:()=>w(!0),handleSaveChanges:D,isLoading:A,setIsLoading:T}),e.jsx("div",{className:"w-full border border-muted rounded-md",children:e.jsx(he,{sellingPlans:r,tableData:C,handleCheckboxChange:Q,variantCheckboxes:v,handleAllVariantsChange:_,allVariantsChecked:g})}),e.jsx(E,{disabled:!M,handleDiscardChanges:()=>w(!0),handleSaveChanges:D,isLoading:A,setIsLoading:T}),e.jsx(X,{isOpen:J,title:"Discard Changes",message:"Are you sure you want to discard all changes?",onConfirm:U,onCancel:()=>{w(!1)}})]})},me=({product:s})=>e.jsx($.Flex,{className:"mt-5",direction:"col",children:e.jsx(fe,{product:s})});function xe({product:s}){return e.jsxs("div",{className:"position-relative",children:[e.jsx(ue,{product:s}),e.jsx(me,{product:s})]})}const Pe=()=>{const s=W(),[o]=ce(Y);return s?o?e.jsx(xe,{product:o}):e.jsxs("div",{className:"flex justify-center items-center h-screen flex-col",children:[e.jsx(F.Loader,{variant:"spinner",className:"h-8 w-8"}),e.jsx("span",{className:"ml-2",children:"Need to load data here..."})]}):null};export{Pe as default};
